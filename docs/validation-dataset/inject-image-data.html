<!DOCTYPE html>
<html>
<head>
    <title>Inject Image Data into Annotations</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #4a9eff; }
        .status { margin: 20px 0; padding: 15px; background: #2d2d2d; border-radius: 5px; }
        .success { border-left: 4px solid #4a9eff; }
        .error { border-left: 4px solid red; }
        button { padding: 10px 20px; margin: 10px; background: #4a9eff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #357abd; }
        .file-input { margin: 20px 0; }
        input[type="file"] { padding: 10px; background: #3d3d3d; border: 1px solid #4d4d4d; border-radius: 4px; color: #e0e0e0; }
        pre { background: #3d3d3d; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .progress { margin: 20px 0; }
        .progress-bar { width: 100%; height: 20px; background: #3d3d3d; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4a9eff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inject Mock Image Data into Annotations</h1>
        
        <div class="status">
            <p>This tool adds mock image data to your annotation file so the benchmark can run.</p>
            <p>It creates synthetic images based on the dimensions in your annotations.</p>
        </div>

        <div class="file-input">
            <label>Select annotation JSON file:</label><br>
            <input type="file" id="file-input" accept=".json">
        </div>

        <button onclick="processFile()">Process & Download Enhanced File</button>
        <button onclick="generateMockDataset()">Generate Full Mock Dataset</button>

        <div class="progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="progress-text">Processing...</p>
        </div>

        <div id="output"></div>
    </div>

    <script>
        function createMockImage(width, height, index) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Dark background
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, width, height);
            
            // Draw mock hexagonal grid pattern
            const hexSize = Math.min(width, height) / 20;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Draw some random hexagons to simulate Nova Drift mods
            for (let i = 0; i < 20; i++) {
                const angle = (i / 20) * Math.PI * 2;
                const radius = (i % 3 + 1) * hexSize * 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                // Random color for each "mod"
                ctx.fillStyle = `hsl(${(index * 30 + i * 50) % 360}, 70%, 50%)`;
                drawHexagon(ctx, x, y, hexSize);
            }
            
            // Add some text to identify the mock
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Arial';
            ctx.fillText(`Mock Image #${index + 1}`, 10, 30);
            ctx.fillText(`${width}x${height}`, 10, 50);
            
            return canvas.toDataURL('image/png');
        }
        
        function drawHexagon(ctx, x, y, size) {
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i;
                const px = x + size * Math.cos(angle);
                const py = y + size * Math.sin(angle);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.fill();
        }
        
        async function processFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a JSON file first');
                return;
            }
            
            const progressBar = document.querySelector('.progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const output = document.getElementById('output');
            
            progressBar.style.display = 'block';
            output.innerHTML = '';
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.annotations || !Array.isArray(data.annotations)) {
                    throw new Error('Invalid annotation file format');
                }
                
                const enhanced = { ...data };
                const total = data.annotations.length;
                
                // Process each annotation
                for (let i = 0; i < total; i++) {
                    const annotation = data.annotations[i];
                    const progress = ((i + 1) / total) * 100;
                    
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Processing ${i + 1}/${total}: ${annotation.filename}`;
                    
                    // Create mock image based on annotation dimensions
                    const width = annotation.image?.width || 1920;
                    const height = annotation.image?.height || 1080;
                    
                    // Add image data to annotation
                    enhanced.annotations[i] = {
                        ...annotation,
                        imageData: createMockImage(width, height, i)
                    };
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // Download enhanced file
                const blob = new Blob([JSON.stringify(enhanced, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `enhanced-${file.name}`;
                a.click();
                URL.revokeObjectURL(url);
                
                progressBar.style.display = 'none';
                output.innerHTML = `
                    <div class="status success">
                        <h3>✅ Success!</h3>
                        <p>Enhanced ${total} annotations with mock image data.</p>
                        <p>Downloaded as: enhanced-${file.name}</p>
                        <p>You can now use this file in the phase0-test-runner.html</p>
                    </div>
                `;
                
            } catch (error) {
                progressBar.style.display = 'none';
                output.innerHTML = `
                    <div class="status error">
                        <h3>❌ Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function generateMockDataset() {
            const output = document.getElementById('output');
            
            // Create a minimal mock dataset for quick testing
            const mockDataset = {
                version: "1.0.0",
                created: new Date().toISOString().split('T')[0],
                totalAnnotations: 5,
                annotations: []
            };
            
            // Generate 5 mock annotations with different sizes
            const mockSizes = [
                { width: 341, height: 936, name: "Narrow portrait" },
                { width: 1920, height: 1080, name: "Full HD" },
                { width: 415, height: 911, name: "Mobile portrait" },
                { width: 2558, height: 1440, name: "Wide screen" },
                { width: 1080, height: 607, name: "Landscape crop" }
            ];
            
            mockSizes.forEach((size, i) => {
                mockDataset.annotations.push({
                    filename: `mock-screenshot-${i + 1}.png`,
                    timestamp: Date.now() + i * 1000,
                    image: {
                        width: size.width,
                        height: size.height
                    },
                    buildArea: {
                        left: Math.floor(size.width * 0.1),
                        top: Math.floor(size.height * 0.05),
                        width: Math.floor(size.width * 0.8),
                        height: Math.floor(size.height * 0.9),
                        right: Math.floor(size.width * 0.9),
                        bottom: Math.floor(size.height * 0.95)
                    },
                    metadata: {
                        uiScale: "100",
                        captureType: i % 2 === 0 ? "fullscreen" : "windowed",
                        qualityScore: 8,
                        visualArtifacts: "clean"
                    },
                    imageData: createMockImage(size.width, size.height, i)
                });
            });
            
            // Download mock dataset
            const blob = new Blob([JSON.stringify(mockDataset, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mock-validation-dataset.json';
            a.click();
            URL.revokeObjectURL(url);
            
            output.innerHTML = `
                <div class="status success">
                    <h3>✅ Mock Dataset Generated!</h3>
                    <p>Created 5 mock annotations with synthetic images.</p>
                    <p>Downloaded as: mock-validation-dataset.json</p>
                    <p>Use this for quick algorithm testing.</p>
                    <details>
                        <summary>Dataset Preview</summary>
                        <pre>${JSON.stringify(mockDataset.annotations[0], null, 2)}</pre>
                    </details>
                </div>
            `;
        }
    </script>
</body>
</html>