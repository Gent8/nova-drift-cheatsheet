<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Crop Workflow Test - Nova Drift</title>
    <link rel="stylesheet" href="manual-crop.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1c24;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2d3a;
            border-radius: 12px;
            padding: 24px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .test-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #1e2028;
            border-radius: 8px;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .test-btn:hover {
            background: #45a049;
        }
        
        .test-btn.secondary {
            background: #666;
        }
        
        .test-btn.secondary:hover {
            background: #777;
        }
        
        .test-output {
            background: #000;
            color: #0f0;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-panel {
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .upload-test-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-test-area:hover {
            background: rgba(76, 175, 80, 0.1);
        }
        
        .upload-test-area.drag-over {
            background: rgba(76, 175, 80, 0.2);
            border-color: #66BB6A;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Manual Crop Workflow Test</h1>
            <p>Test the complete Nova Drift screenshot import workflow</p>
        </div>

        <div class="test-section">
            <h3>üì∑ Upload & Crop Test</h3>
            <div class="test-controls">
                <button class="test-btn" onclick="testUploadInterface()">Test Upload UI</button>
                <button class="test-btn" onclick="testCropInterface()">Test Crop Interface</button>
                <button class="test-btn" onclick="testWorkflow()">Test Full Workflow</button>
                <button class="test-btn secondary" onclick="resetTest()">Reset</button>
            </div>
            
            <div class="upload-test-area" id="test-upload-area">
                <p>üìÅ Drop a Nova Drift screenshot here or click to browse</p>
                <small>This will test the complete workflow: Upload ‚Üí Crop ‚Üí Recognition</small>
            </div>
            <input type="file" id="test-file-input" accept="image/*" style="display: none;">
        </div>

        <div class="test-section">
            <h3>‚öôÔ∏è System Status</h3>
            <div class="status-panel">
                <div><strong>State Machine:</strong> <span id="state-status">Not initialized</span></div>
                <div><strong>Crop Interface:</strong> <span id="crop-status">Not initialized</span></div>
                <div><strong>Recognition Engine:</strong> <span id="recognition-status">Not initialized</span></div>
                <div><strong>Current State:</strong> <span id="current-state">idle</span></div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìã Event Log</h3>
            <div class="test-controls">
                <button class="test-btn secondary" onclick="clearLog()">Clear Log</button>
                <button class="test-btn secondary" onclick="enableDebugMode()">Enable Debug</button>
            </div>
            <div class="test-output" id="event-log">Waiting for events...\n</div>
        </div>
    </div>

    <!-- Load all required scripts -->
    <script src="modules/upload-validator.js"></script>
    <script src="modules/progress-indicator.js"></script>
    <script src="modules/upload-handler.js"></script>
    <script src="modules/manual-crop-interface.js"></script>
    <script src="modules/import-coordinator.js"></script>
    
    <!-- Load recognition system -->
    <script src="two-zone-grid-mapper.js"></script>
    <script src="recognition-engine/recognition-utils.js"></script>
    <script src="recognition-engine/two-zone-recognition-engine.js"></script>
    <script src="recognition-engine/recognition-engine-v2.js"></script>

    <script>
        // Test utilities
        let testLog = [];
        let testUploadHandler;
        let testCropInterface;
        let testImportCoordinator;

        // Initialize test environment
        function initializeTest() {
            log('üöÄ Initializing test environment...');

            try {
                // Initialize components
                testCropInterface = new ManualCropInterface({
                    enableDebugMode: true
                });
                window.manualCropInterface = testCropInterface;
                updateStatus('crop-status', 'Initialized ‚úÖ');

                testImportCoordinator = new ImportCoordinator({
                    enableDebugMode: true,
                    processingTimeout: 10000 // Shorter timeout for testing
                });
                window.importCoordinator = testImportCoordinator;
                updateStatus('state-status', 'Initialized ‚úÖ');

                testUploadHandler = new ScreenshotUploadHandler();
                
                // Check recognition engine availability
                const engineStatus = [];
                if (typeof RecognitionEngineV2 !== 'undefined') {
                    engineStatus.push('RecognitionEngineV2 ‚úÖ');
                }
                if (typeof TwoZoneRecognitionEngine !== 'undefined') {
                    engineStatus.push('TwoZoneRecognitionEngine ‚úÖ');
                }
                updateStatus('recognition-status', engineStatus.length > 0 ? engineStatus.join(', ') : 'Not loaded ‚ùå');

                // Setup test event listeners
                setupTestEventListeners();

                log('‚úÖ Test environment ready');
            } catch (error) {
                log('‚ùå Initialization failed: ' + error.message);
            }
        }

        function setupTestEventListeners() {
            // Log all relevant events
            const events = [
                'screenshot-ready',
                'crop-applied', 
                'recognition-complete',
                'import-state-change',
                'mods-imported'
            ];

            events.forEach(eventName => {
                document.addEventListener(eventName, (e) => {
                    log(`üì° Event: ${eventName}`, e.detail);
                    
                    if (eventName === 'import-state-change') {
                        updateStatus('current-state', e.detail.newState);
                    } else if (eventName === 'recognition-complete') {
                        displayRecognitionResults(e.detail);
                    } else if (eventName === 'mods-imported') {
                        displayFinalResults(e.detail);
                    }
                });
            });
        }

        // Test functions
        function testUploadInterface() {
            log('üß™ Testing upload interface...');
            const uploadArea = document.getElementById('test-upload-area');
            uploadArea.click();
        }

        function testCropInterface() {
            log('üß™ Testing crop interface with mock data...');
            
            // Create mock image data
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // Draw mock Nova Drift interface
            ctx.fillStyle = '#1a1c24';
            ctx.fillRect(0, 0, 800, 600);
            
            // Draw mock build area
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(200, 150, 400, 300);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.fillText('Mock Nova Drift Build Area', 300, 300);

            const mockData = {
                file: { name: 'test-screenshot.png', size: 12345 },
                dimensions: { width: 800, height: 600 },
                metadata: { dataUrl: canvas.toDataURL() }
            };

            if (testCropInterface) {
                testCropInterface.show(mockData);
                log('‚úÖ Crop interface opened with mock data');
            } else {
                log('‚ùå Crop interface not available');
            }
        }

        function testWorkflow() {
            log('üß™ Testing complete workflow...');
            testCropInterface();
        }

        function resetTest() {
            log('üîÑ Resetting test environment...');
            
            if (testImportCoordinator) {
                testImportCoordinator.reset();
            }
            
            if (testCropInterface && testCropInterface.isVisible()) {
                testCropInterface.hide();
            }
            
            updateStatus('current-state', 'idle');
            log('‚úÖ Reset complete');
        }

        function enableDebugMode() {
            log('üêõ Enabling debug mode...');
            if (testImportCoordinator) {
                testImportCoordinator.options.enableDebugMode = true;
                testImportCoordinator.enableDebugMode();
            }
        }

        // Utility functions
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            if (data) {
                testLog.push(`  Data: ${JSON.stringify(data, null, 2)}`);
            }
            
            updateLogDisplay();
            console.log(logEntry, data);
        }

        function updateLogDisplay() {
            const logEl = document.getElementById('event-log');
            logEl.textContent = testLog.slice(-50).join('\n'); // Show last 50 entries
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(elementId, status) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = status;
            }
        }

        function clearLog() {
            testLog = [];
            updateLogDisplay();
        }

        // Display recognition results in detail
        function displayRecognitionResults(results) {
            log('üîç Recognition Results Summary:');
            log(`  ‚Ä¢ Processing Engine: ${results.metadata?.processingEngine || 'Unknown'}`);
            log(`  ‚Ä¢ Processing Time: ${results.processingTime}ms`);
            log(`  ‚Ä¢ Overall Confidence: ${Math.round(results.confidence * 100)}%`);
            log(`  ‚Ä¢ Image Size: ${results.metadata?.imageSize?.width}x${results.metadata?.imageSize?.height}`);
            
            if (results.coreMods && results.coreMods.length > 0) {
                log(`  ‚Ä¢ Core Mods (${results.coreMods.length}):`);
                results.coreMods.forEach(mod => {
                    log(`    - ${mod.name}: ${Math.round(mod.confidence * 100)}% (${mod.type || 'core'})`);
                });
            }
            
            if (results.regularMods && results.regularMods.length > 0) {
                log(`  ‚Ä¢ Regular Mods (${results.regularMods.length}):`);
                results.regularMods.forEach(mod => {
                    log(`    - ${mod.name}: ${Math.round(mod.confidence * 100)}%`);
                });
            }
            
            const totalMods = (results.coreMods?.length || 0) + (results.regularMods?.length || 0);
            log(`  ‚Ä¢ Total Detected: ${totalMods} mods`);
        }

        // Display final imported results
        function displayFinalResults(importData) {
            log('‚úÖ Final Import Results:');
            log(`  ‚Ä¢ Total Imported Mods: ${importData.metadata?.totalMods || importData.mods?.length || 0}`);
            log(`  ‚Ä¢ Final Confidence: ${Math.round(importData.confidence * 100)}%`);
            log(`  ‚Ä¢ Review Completed: ${importData.metadata?.reviewCompleted ? 'Yes' : 'No'}`);
            log(`  ‚Ä¢ Total Processing Time: ${importData.metadata?.processingTime || 'Unknown'}ms`);
            
            if (importData.mods && importData.mods.length > 0) {
                log(`  ‚Ä¢ Imported Mods:`);
                importData.mods.forEach(modName => {
                    log(`    - ${modName}`);
                });
            }
        }

        // Setup drag and drop for test area
        function setupTestUpload() {
            const uploadArea = document.getElementById('test-upload-area');
            const fileInput = document.getElementById('test-file-input');

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleTestFile(e.target.files[0]);
                }
            });

            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            uploadArea.addEventListener('dragenter', () => {
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                uploadArea.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handleTestFile(e.dataTransfer.files[0]);
                }
            });
        }

        function handleTestFile(file) {
            log(`üìÅ Test file selected: ${file.name} (${file.size} bytes)`);
            
            if (testUploadHandler) {
                // Simulate the upload process
                testUploadHandler.handleFileSelection([file]);
            } else {
                log('‚ùå Upload handler not available');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTest();
            setupTestUpload();
        });
    </script>
</body>
</html>